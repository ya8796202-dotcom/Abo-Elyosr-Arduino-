<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>محادثة صاحب المنصة — ثابت</title>
  <style>
    :root{ --bg:#07102a; --panel:#0b1224; --accent:#06b6d4; --text:#e6eef8; --muted:#93c5fd; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,"Noto Naskh Arabic",sans-serif;background:linear-gradient(180deg,#07102a,#0b1224);color:var(--text);padding:18px}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#1d4ed8)}
    h1{margin:0;font-size:18px}
    .panel{display:grid;grid-template-columns:1fr 320px;gap:12px;background:linear-gradient(180deg,#071428,#07102a);border:1px solid #0f1b38;border-radius:10px;overflow:hidden}
    @media(max-width:900px){ .panel{grid-template-columns:1fr} }
    .chat-area{display:flex;flex-direction:column;height:68vh}
    .chat-body{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .bubble{max-width:78%;padding:10px 12px;border-radius:12px;word-break:break-word}
    .me{align-self:flex-end;background:linear-gradient(180deg,#1d4ed8,#1e40af);color:#fff}
    .owner{align-self:flex-start;background:linear-gradient(180deg,#06b6d4,#0ea5a4);color:#022}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-footer{display:flex;gap:8px;padding:10px;border-top:1px solid #0f1b38;background:linear-gradient(180deg,#071428,#07102a)}
    input.name{width:140px;padding:8px;border-radius:8px;border:1px solid #0f1b38;background:#071428;color:var(--text)}
    textarea.msg{flex:1;padding:8px;border-radius:8px;border:1px solid #0f1b38;background:#071428;color:var(--text);resize:vertical;height:56px}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#022;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #0f1b38;color:var(--text)}
    .sidebar{padding:12px;border-left:1px solid #0f1b38;overflow:auto}
    .section{margin-bottom:12px}
    .template{background:rgba(255,255,255,.02);padding:8px;border-radius:8px}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>محادثة صاحب المنصة</h1>
        <div class="small">واجهة مستقلة؛ الردود مولّدة محليًا وتُحفظ في المتصفح</div>
      </div>
    </header>

    <div class="panel" role="application">
      <!-- Chat column -->
      <div class="chat-area" aria-live="polite">
        <div class="chat-body" id="chatBody" tabindex="0"></div>

        <div class="chat-footer" role="region" aria-label="مربع الكتابة">
          <input id="userName" class="name" placeholder="اسمك (اختياري)" />
          <textarea id="userMsg" class="msg" placeholder="اكتب رسالتك هنا..."></textarea>
          <button id="sendBtn" class="btn">إرسال</button>
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="sidebar" aria-label="إعدادات">
        <div class="section">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <strong>الرد التلقائي</strong>
            <button id="toggleAuto" class="btn ghost">إيقاف</button>
          </div>
          <div class="small" style="margin-top:8px">يمكنك تعطيل/تفعيل الردود الآلية.</div>
        </div>

        <div class="section">
          <strong>قوالب سريعة</strong>
          <div style="display:flex;gap:6px;margin-top:8px">
            <input id="tplKey" class="small" placeholder="كلمة مفتاحية" />
            <input id="tplText" class="small" placeholder="نص الرد" />
          </div>
          <div style="display:flex;gap:6px;margin-top:8px">
            <button id="addTpl" class="btn ghost">أضف</button>
            <button id="exportTpl" class="btn ghost">تصدير</button>
          </div>
          <div id="tplList" style="margin-top:10px"></div>
        </div>

        <div class="section">
          <strong>المحادثة</strong>
          <div style="display:flex;gap:6px;margin-top:8px">
            <button id="exportChat" class="btn ghost">تصدير</button>
            <button id="importChat" class="btn ghost">استيراد</button>
            <button id="clearChat" class="btn ghost">مسح</button>
          </div>
        </div>

        <div class="section small">
          <div>اختصار: اضغط Enter لإرسال (Shift+Enter لسطر جديد).</div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // مفاتيح التخزين
    const CHAT_KEY = 'chat_only_fixed_v1';
    const TPL_KEY = 'chat_only_fixed_templates_v1';

    // عناصر DOM
    const chatBody = document.getElementById('chatBody');
    const userName = document.getElementById('userName');
    const userMsg = document.getElementById('userMsg');
    const sendBtn = document.getElementById('sendBtn');
    const toggleAuto = document.getElementById('toggleAuto');
    const tplKey = document.getElementById('tplKey');
    const tplText = document.getElementById('tplText');
    const addTpl = document.getElementById('addTpl');
    const tplList = document.getElementById('tplList');
    const exportTpl = document.getElementById('exportTpl');
    const exportChat = document.getElementById('exportChat');
    const importChat = document.getElementById('importChat');
    const clearChat = document.getElementById('clearChat');

    // حالة التطبيق
    let chatState = loadChat();
    let templates = loadTemplates();
    let autoReply = true;

    // تهيئة واجهة
    renderChat();
    renderTemplates();

    // تحميل/حفظ
    function loadChat(){
      try{ return JSON.parse(localStorage.getItem(CHAT_KEY)) || { messages: [] }; }catch(e){ return { messages: [] }; }
    }
    function saveChat(){ localStorage.setItem(CHAT_KEY, JSON.stringify(chatState)); }
    function loadTemplates(){
      try{ return JSON.parse(localStorage.getItem(TPL_KEY)) || []; }catch(e){ return []; }
    }
    function saveTemplates(){ localStorage.setItem(TPL_KEY, JSON.stringify(templates)); }

    // عرض المحادثة
    function renderChat(){
      chatBody.innerHTML = '';
      if(chatState.messages.length === 0){
        appendOwner('أهلاً! ابدأ المحادثة وسأرد عليك.');
        return;
      }
      chatState.messages.forEach(m => {
        const el = document.createElement('div');
        el.className = 'bubble ' + (m.who === 'me' ? 'me' : 'owner');
        el.innerHTML = `<div class="meta">${escapeHTML(m.name || (m.who==='me'?'أنت':'صاحب المنصة'))} • ${escapeHTML(m.time)}</div><div>${escapeHTML(m.text)}</div>`;
        chatBody.appendChild(el);
      });
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // إضافة رسائل
    function appendMe(name, text){
      const msg = { who:'me', name: name || 'مستخدم', text, time: new Date().toLocaleString('ar-EG') };
      chatState.messages.push(msg); saveChat(); renderChat();
    }
    function appendOwner(text){
      const msg = { who:'owner', name:'صاحب المنصة', text, time: new Date().toLocaleString('ar-EG') };
      chatState.messages.push(msg); saveChat(); renderChat();
    }

    // إرسال المستخدم
    sendBtn.addEventListener('click', sendHandler);
    userMsg.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendHandler(); }
    });

    function sendHandler(){
      const text = userMsg.value.trim();
      if(!text) return;
      const name = userName.value.trim() || 'مستخدم';
      appendMe(name, text);
      userMsg.value = '';
      if(autoReply) simulateReply(text, name);
    }

    // محاكاة رد صاحب المنصة مع مؤشر كتابة
    function simulateReply(userText, userName){
      // ضع مؤشر كتابة مؤقت
      const typing = { who:'owner', name:'صاحب المنصة', text:'...', time: new Date().toLocaleString('ar-EG'), typing:true };
      chatState.messages.push(typing); renderChat();

      setTimeout(()=> {
        // أزل مؤشر الكتابة
        chatState.messages = chatState.messages.filter(m => !m.typing);
        // أنشئ الرد
        const reply = generateReply(userText, userName);
        chatState.messages.push({ who:'owner', name:'صاحب المنصة', text: reply, time: new Date().toLocaleString('ar-EG') });
        saveChat(); renderChat();
      }, 600 + Math.random()*800);
    }

    // مولد الردود (قواعد بسيطة + قوالب)
    function generateReply(userText, userName){
      const t = userText.toLowerCase();

      // طلب درس: "درس 5" أو "L5"
      const lessonMatch = t.match(/درس\s*(\d+)|\bl(\d+)\b|lesson\s*(\d+)/i);
      if(lessonMatch){
        const num = lessonMatch[1] || lessonMatch[2] || lessonMatch[3];
        return `طلبت الدرس رقم ${num}. أرسل "كود درس ${num}" أو "ملخص درس ${num}" وسأساعدك.`;
      }

      // تحقق من القوالب
      for(const tpl of templates){
        if(!tpl.keyword) continue;
        if(t.includes(tpl.keyword.toLowerCase())) return tpl.reply.replace(/\{\{name\}\}/g, userName || '');
      }

      // كلمات مفتاحية عامة
      const keywords = [
        { keys:['wifi','esp','esp8266','esp32'], reply:'لو تستخدم ESP تأكد من SSID/PASS واختيار اللوحة في IDE.' },
        { keys:['neopixel','ws2812','neo'], reply:'لـ NeoPixel استخدم مكتبة Adafruit_NeoPixel ومزود طاقة مناسب.' },
        { keys:['motor','l298','servo'], reply:'المحركات تحتاج درايفر ومصدر طاقة منفصل؛ لا توصلها مباشرة.' },
        { keys:['github','رفع'], reply:'أقدر أشرح خطوات رفع المشروع على GitHub خطوة بخطوة.' }
      ];
      for(const k of keywords){
        for(const word of k.keys){
          if(t.includes(word)) return k.reply;
        }
      }

      // أخطاء عامة
      if(/error|compile|upload|خطأ|فشل/i.test(t)) return 'انسخ لي نص الخطأ أو صورة من Serial Monitor وسأحاول أساعدك في التصحيح.';

      // رد افتراضي
      const fallbacks = [
        `فكرة جيدة، ${userName || ''}. أقدر أقدملك مثال أو خطوات مفصّلة.`,
        'هل تريد شرح التوصيلات أم الكود؟',
        'جرّب تشغيل الكود على المحاكي أولاً ثم نجرب التعديلات.'
      ];
      return fallbacks[Math.floor(Math.random()*fallbacks.length)];
    }

    // قوالب: إضافة/عرض/حذف
    function renderTemplates(){
      tplList.innerHTML = '';
      if(templates.length === 0){ tplList.innerHTML = '<div class="template small">لا توجد قوالب بعد.</div>'; return; }
      templates.forEach((t, idx) => {
        const el = document.createElement('div'); el.className='template';
        el.innerHTML = `<div style="font-weight:700">${escapeHTML(t.keyword)}</div><div style="margin-top:6px">${escapeHTML(t.reply)}</div>
          <div style="display:flex;gap:6px;margin-top:8px">
            <button data-edit="${idx}" class="btn ghost small">تعديل</button>
            <button data-del="${idx}" class="btn ghost small">حذف</button>
          </div>`;
        tplList.appendChild(el);
      });
    }

    addTpl.addEventListener('click', ()=>{
      const k = tplKey.value.trim(); const r = tplText.value.trim();
      if(!k || !r){ alert('أدخل كلمة مفتاحية ونص الرد'); return; }
      templates.push({ keyword: k, reply: r });
      saveTemplates(); tplKey.value=''; tplText.value=''; renderTemplates();
    });

    tplList.addEventListener('click', (e)=>{
      const edit = e.target.getAttribute('data-edit');
      const del = e.target.getAttribute('data-del');
      if(edit !== null){
        const idx = Number(edit);
        const t = templates[idx];
        const newK = prompt('تعديل الكلمة المفتاحية', t.keyword);
        if(newK === null) return;
        const newR = prompt('تعديل نص الرد (استخدم {{name}} لاسم المستخدم)', t.reply);
        if(newR === null) return;
        templates[idx] = { keyword: newK, reply: newR };
        saveTemplates(); renderTemplates();
      } else if(del !== null){
        const idx = Number(del);
        if(confirm('حذف القالب؟')){ templates.splice(idx,1); saveTemplates(); renderTemplates(); }
      }
    });

    // زر التبديل التلقائي
    toggleAuto.addEventListener('click', ()=>{
      autoReply = !autoReply;
      toggleAuto.textContent = autoReply ? 'إيقاف' : 'تشغيل';
      appendOwner(autoReply ? 'الرد التلقائي مفعل' : 'الرد التلقائي متوقف');
    });

    // تصدير/استيراد/مسح المحادثة
    exportChat.addEventListener('click', ()=> {
      const w = window.open('', '_blank');
      w.document.body.style.background = '#071428';
      w.document.body.style.color = '#d7e3ff';
      const pre = w.document.createElement('pre'); pre.textContent = JSON.stringify(chatState, null, 2);
      pre.style.whiteSpace='pre-wrap'; pre.style.padding='12px';
      w.document.body.appendChild(pre);
    });
    importChat.addEventListener('click', ()=> {
      const txt = prompt('ألصق JSON المحادثة هنا للاستيراد');
      if(!txt) return;
      try{
        const obj = JSON.parse(txt);
        if(obj && Array.isArray(obj.messages)){ chatState = obj; saveChat(); renderChat(); alert('تم الاستيراد'); }
        else alert('الملف غير صالح');
      }catch(e){ alert('خطأ في قراءة JSON'); }
    });
    clearChat.addEventListener('click', ()=> {
      if(!confirm('مسح المحادثة؟')) return;
      chatState.messages = []; saveChat(); renderChat();
    });

    // تصدير القوالب
    exportTpl.addEventListener('click', ()=> {
      const w = window.open('', '_blank');
      w.document.body.style.background = '#071428';
      w.document.body.style.color = '#d7e3ff';
      const pre = w.document.createElement('pre'); pre.textContent = JSON.stringify(templates, null, 2);
      pre.style.whiteSpace='pre-wrap'; pre.style.padding='12px';
      w.document.body.appendChild(pre);
    });

    // مساعدة صغيرة
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch])); }

    // تهيئة أولية: إذا لا توجد محادثة، أضف رسالة ترحيب
    if(!chatState.messages || chatState.messages.length === 0){
      chatState.messages = [{ who:'owner', name:'صاحب المنصة', text:'أهلاً! ابدأ المحادثة وسأرد عليك.', time: new Date().toLocaleString('ar-EG') }];
      saveChat();
    }
    renderChat();

    // تحميل القوالب الافتراضية إن لم توجد
    if(!templates || templates.length === 0){
      templates = [
        { keyword:'رفع', reply:'لو تريد خطوات رفع المشروع على GitHub أقدر أكتب لك دليل مختصر.' },
        { keyword:'wokwi', reply:'يمكنك تشغيل الكود داخل المحاكي أو لصق الكود هنا وسأرشدك.' }
      ];
      saveTemplates();
    }
    renderTemplates();
  </script>
</body>
</html>
